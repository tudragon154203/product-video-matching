# Contracts Spec ## 1. Envelope chuẩn Mọi event pub/sub đều tuân theo cấu trúc JSON envelope sau: { "event_id": "uuid-v4", "schema_version": "v1", "type": "<topic-name>", "source": "<service-name>", "occurred_at": "ISO8601", "trace": { "job_id": "...", "parent_event_id": "..." }, "payload": { ... } } ## 2. RabbitMQ Routing - Exchange: `events` (type: topic, durable: true) - Queue: mỗi service một queue, binding key theo topic. - DLQ: `<queue>.dlq` với TTL retry 5m → requeue. - Validate event trước khi xử lý (JSON Schema). ## 3. Topics & JSON Schema ### 3.1 products.collect.request { "job_id": "string", "industry": "string", "top_amz": "integer", "top_ebay": "integer" } ### 3.2 products.image.ready { "product_id": "string", "image_id": "string", "local_path": "string" } ### 3.3 videos.search.request { "job_id": "string", "industry": "string", "queries": ["string"], "platforms": ["youtube", "bilibili"], "recency_days": "integer" } ### 3.4 videos.keyframes.ready { "video_id": "string", "frames": [ { "frame_id": "string", "ts": "float", "local_path": "string" } ] } ### 3.5 features.ready { "entity_type": "product_image|video_frame", "id": "string", "emb_rgb": ["float"], "emb_gray": ["float"], "kp_blob_path": "string" } ### 3.6 match.request { "job_id": "string", "industry": "string", "product_set_id": "string", "video_set_id": "string", "top_k": "integer" } ### 3.7 match.result { "job_id": "string", "product_id": "string", "video_id": "string", "best_pair": { "product_img": "string", "video_frame": "string" }, "score": "float", "ts": "float" } ### 3.8 match.result.enriched { "job_id": "string", "product_id": "string", "video_id": "string", "best_pair": { "product_img": "string", "video_frame": "string" }, "score": "float", "ts": "float", "evidence_path": "string" } ## 4. Quy tắc - Validate trước khi pub/sub. - Version schema tăng khi thay đổi breaking. - Mọi id là string không rỗng. - Mọi float ≤ 6 chữ số thập phân. - Payload ≤ 1MB (tránh quá tải bus).