# Docker Compose Configuration

This directory contains Docker Compose configurations for the Product Video Matching project.

## Files

- `docker-compose.dev.yml`: The primary development configuration file. This is the only file that should be manually edited.
- `docker-compose.mac.yml`: macOS-specific configuration with absolute paths. This file is automatically generated from `docker-compose.dev.yml`.

## Synchronization Process

The `docker-compose.mac.yml` file is automatically synchronized from `docker-compose.dev.yml` using a Python script. This process converts relative paths to absolute paths to ensure compatibility with Docker Desktop on macOS.

### How It Works

1. A Python script (`sync_compose.py`) reads `docker-compose.dev.yml`
2. It identifies volume mappings with relative paths (e.g., `../../data:/app/data`)
3. It converts these relative paths to absolute paths based on the repository root
4. The transformed configuration is written to `docker-compose.mac.yml`

### Path Conversion Examples

| Development Path (Relative) | macOS Path (Absolute) |
|----------------------------|-----------------------|
| `../../data:/app/data` | `/Users/username/product-video-matching/data:/app/data` |
| `../../libs:/app/libs` | `/Users/username/product-video-matching/libs:/app/libs` |

## Editing Guidelines

### Development Workflow

1. **Only edit `docker-compose.dev.yml`**: All manual changes should be made to this file
2. **Never manually edit `docker-compose.mac.yml`**: This file is automatically generated
3. **Changes are synchronized automatically**: The pre-commit hook ensures `docker-compose.mac.yml` stays up-to-date

### Pre-commit Hook

A pre-commit hook is installed to automatically synchronize the compose files:

- Runs `python infra/pvm/sync_compose.py` before each commit
- Automatically stages any changes to `docker-compose.mac.yml`
- Ensures consistency between the two configuration files

To manually run the synchronization:
```bash
python infra/pvm/sync_compose.py
```

## Usage

### Development (All Platforms)
```bash
docker compose -f infra/pvm/docker-compose.dev.yml up -d --build
```

### macOS
```bash
docker compose -f infra/pvm/docker-compose.mac.yml up -d --build
```

## Troubleshooting

If you encounter path-related issues on macOS:

1. Ensure the pre-commit hook is installed and working
2. Manually run the synchronization script: `python infra/pvm/sync_compose.py`
3. Check that `docker-compose.mac.yml` has been updated with absolute paths